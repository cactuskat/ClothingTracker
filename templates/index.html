<!DOCTYPE html>
<html>
<head>
  <title>Cher's Closet</title>
</head>
<body>

  <form id="outfitForm">
    <label for="zipcode">Zipcode:</label>
     <input id="zipcode" type="text">
    <!---<input id="zipcode" type="text" maxlength="5" pattern="\d{5}" title="5 digits" required>--->
    <br>
    <input id="accessoryBtn" type="checkbox" value="addAccessory"/>
    <label for="accessoryBtn">Accessory?</label>
    <button id="createBtn" type="submit">Create!</button>
  </form>
  <br><br>
  <img id="top" width="100px" height="100px" src="/static/imgs/Placeholders/blank.png">
  <img id="bottom" width="100px" height="100px" src="/static/imgs/Placeholders/blank.png">
  <img id="accessory" width="100px" height="100px" src="/static/imgs/Placeholders/blank.png">
  <p id="weatherBox"></p>

  <script>
    const debug = 1;

    // Classes ---
    class Clothing {
      constructor({id=null,name=null,type=null,weather=null,path=null} = {}){
        this.id = id;
        this.name = null;
        this.type = type;
        this.weather = weather;
        this.path = path;}
    }
    class Outfit {
      constructor({top=null, bottom=null, accessory=null} = {}){
        this.top = top; 
        this.bottom = bottom;
        this.accessory = accessory;
        }
    }

    // Global Variables ---
    var mannequinOutfit = new Outfit();
    const createBtn = document.getElementById("createBtn");
    const form = document.getElementById("outfitForm")

    // Methods ---    
    form.addEventListener("submit",async(event) => {
      event.preventDefault();
      await updateMannequinOutfit();
      updateOutfitImage();
    })

    // Functions ---
    /*
    Purpose: Fetches weather condition based on console location or input zipcode
    Input: NONE
    Return: hot(>=75), mid(74-60), cold(<= 60)
    */
    async function fetchWeather() {
      let query;
        try {
          const zipcodeTextbox = document.getElementById("zipcode")
          if(!zipcodeTextbox) {throw new Error("fetchWeather Error: no zipcode textbox")}
          
          if (zipcodeTextbox.value.trim().length > 0)
          {
            const zipcode = zipcodeTextbox.value.trim();
            query = `/weather/get/today?zipcode=${zipcode}`;
            if (debug) {console.log(`Zipcode:${zipcode})`);} 
          } else {
            const position = await new Promise((resolve, reject) => {
              navigator.geolocation.getCurrentPosition(resolve,reject);});
            const lon = position.coords.longitude;
            const lat = position.coords.latitude;
            query = `/weather/get/today?lat=${lat}&lon=${lon}`
            if (debug) {console.log(`Coords:(${lat},${lon})`)}
          }

          const response = await fetch(query);
          if (!response.ok) { throw new Error(`Fetch error: ${response.status}`);}

          const result = await response.json();
          if (debug) {console.log('fetchWeather JSON data :',result);}

          const temp = result.temp;
          if (debug) {console.log("Temp:",temp)}
          if (temp >= 75){
            return "hot";
          } else if (temp <= 60){
            return "cold";
          } else {
            return "mid";
          }
        } catch (error) {
          console.error(error.message);
          return null;
        }
      }
      
    /*
    Purpose: Fetches a clothing from closet_list.db
    Input: clothingType (clothing object type), Weather(temp of user)
    Return: clothing object data
    */
    async function fetchClothing(clothingType,weather){
      if (debug) {console.log(`fetchClothing with ${clothingType} & ${weather}`)}
      try {
        const response = await fetch(`/clothing/search?type=${encodeURIComponent(clothingType)}&weather=${encodeURIComponent(weather)}`);
        if (!response.ok) { throw new Error(`Fetch error: ${response.status}`);}
        const result = await response.json();
        if (debug) {console.log('fetchClothing JSON data:',result);}
        return result;
      } catch (error) {
        console.error(error.message);
        return null;
      }
    }

    /*
    Purpose: Creates an outfit according to the weather & accessory choice
    Input: NONE
    Return: VOID
    */
    async function createOutfit(){
      const outfit = new Outfit();
      isAccessoryActive = document.getElementById("accessoryBtn").checked;
      weather = await fetchWeather();

      for (const clothingType of Object.keys(outfit)) {
        if (!isAccessoryActive && clothingType === "accessory") {continue;} 
        const clothingWeather = (isAccessoryActive && clothingType === "accessory") ? "all" : weather;
        const response = await fetchClothing(clothingType,clothingWeather);
        if (!response){
          console.log(`No data returned from fetchClothing(${clothingType},${clothingWeather})`);
        } else if (response.error){
          console.log("Error from backend:",response.error);
        }

       outfit[clothingType] = new Clothing({
        id:response.id,
        name:response.name,
        type:clothingType,
        weather:clothingWeather,
        path:response.path});
      }

      if (debug) console.log("Created outfit:",outfit);
      return outfit;
    }

    /*
    Purpose: Updates mannequin outfit with new pieces according to the weather
    Input: NONE
    Return: VOID
    */
    async function updateMannequinOutfit(weather) {
      mannequinOutfit = await createOutfit();
      if (debug) console.log("Dressed mannequin:",mannequinOutfit);
    }

    /*
    Purpose: Updates mannequinn images to reflect mannequinnOutfit.
    Input: NONE
    Return: VOID
    */
    function updateOutfitImage(){   
      for (const clothingType of Object.keys(mannequinOutfit)){ 
        const element = document.getElementById(clothingType);
        if (!element) {continue;}
        
        const item = mannequinOutfit[clothingType];

        if (item && item.path) {
          element.src = "/static/" +  item.path;
          element.alt = item.name;
          if (debug) {console.log("Image Mannequinn:",clothingType);}
          continue;
        }
        // if no image or item if found, a placeholder will be placed
        element.src = "/static/imgs/Placeholders/blank.png";
        element.alt = "blank";
      }
    }
  
  </script>
</body>
</html>