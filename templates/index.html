<!DOCTYPE html>
<html>
<head>
  <title>Cher's Closet</title>
</head>
<body>

  <input id="accessoryBtn" type="checkbox" value="addAccessory"/>
  <label for="accessoryBtn">Accessory?</label>
  <button id="createBtn" type="button">Create!</button>
  <br><br>
  <img id="top" width="100px" height="100px" src="/static/imgs/Placeholders/blank.png">
  <img id="bottom" width="100px" height="100px" src="/static/imgs/Placeholders/blank.png">
  <img id="accessory" width="100px" height="100px" src="/static/imgs/Placeholders/blank.png">

  <script>
    const debug = 1;
    // Classes ---
    class Clothing {
      constructor({id=null,name=null,type=null,weather=null,path=null} = {}){
        this.id = id;
        this.name = null;
        this.type = type;
        this.weather = weather;
        this.path = path;}
    }
    class Outfit {
      constructor({top=null, bottom=null, accessory=null} = {}){
        this.top = top; 
        this.bottom = bottom;
        this.accessory = accessory;
        }
    }

    // Global Variables ---
    var mannequinOutfit = new Outfit();
    const createBtn = document.getElementById("createBtn");

    // Methods ---    
    createBtn.addEventListener("click",async () => {
      await updateMannequinOutfit(); updateOutfitImage();});

    // Functions ---

    /*
    Purpose: Fetches a clothing from closet_list.db
    Input: clothingType,Weather(temp of user)
    Return: clothing object data
    */
    async function fetchClothing(clothingType,weather){
      if (debug) {console.log(`Entering fetchClothing with ${clothingType} & ${weather}`)}
      try {
        const response = await fetch(`/clothing/search?type=${encodeURIComponent(clothingType)}&weather=${encodeURIComponent(weather)}`);
        if (!response.ok) {
          throw new Error(`Fetch error: ${response.status}`);
        }
        const result = await response.json();
        if (debug) {console.log('Parsed JSON data:',result);}
        return result;
      } catch (error) {
        console.error(error.message);
        return null;}
    }

    /*
    Purpose: Creates an outfit according to the weather & accessory choice
    Input: Weather(temp of user,string)
    Return: VOID
    */
    async function createOutfit(weather){
      const outfit = new Outfit();
      isAccessoryActive = document.getElementById("accessoryBtn").checked;

      for (const clothingType of Object.keys(outfit)) {
        if (!isAccessoryActive && clothingType === "accessory") {continue;} 
        const clothingWeather = (isAccessoryActive && clothingType === "accessory") ? "all" : weather;
        const response = await fetchClothing(clothingType,clothingWeather);
        if (!response){
          console.log(`No data returned from fetchClothing(${clothingType},${clothingWeather})`);
        } else if (response.error){
          console.log("Error from backend:",response.error);
        }

       outfit[clothingType] = new Clothing({
        id:response.id,
        name:response.name,
        type:clothingType,
        weather:clothingWeather,
        path:response.path});
      }

      if (debug) console.log("Created outfit:",outfit);
      return outfit;
    }

    /*
    Purpose: Updates mannequin outfit with new pieces according to the weather
    Input: Weather(temp of user,string)
    Return: VOID
    */
    async function updateMannequinOutfit(weather) {
      mannequinOutfit = await createOutfit("hot");
      if (debug) console.log("Dressed mannequin:",mannequinOutfit);
    }

    /*
    Purpose: Updates mannequinn images to reflect mannequinnOutfit.
    Input: NONE
    Return: VOID
    */
    function updateOutfitImage(){   
      for (const clothingType of Object.keys(mannequinOutfit)){ 
        const element = document.getElementById(clothingType);
        if (!element) {continue;}
        
        const item = mannequinOutfit[clothingType];

        if (item && item.path) {
          element.src = "/static/" +  item.path;
          element.alt = item.name;
          if (debug) {console.log("Image Mannequinn:",clothingType);}
          continue;
        }
        element.src = "/static/imgs/Placeholders/blank.png";
        element.alt = "blank";
      }
    }
  
  </script>
</body>
</html>